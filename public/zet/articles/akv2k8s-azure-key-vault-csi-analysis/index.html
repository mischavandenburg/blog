<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Comparing akv2k8s with Azure Key Vault Provider for Secret Store CSI Driver | Mischa van den Burg</title>
<meta name=keywords content="Article,Azure,Security,Kubernetes,AKS"><meta name=description content="In a recent analysis, I explored two notable solutions for synchronizing secrets from Azure Key Vaults to AKS (Azure Kubernetes Service) clusters: akv2k8s and the Azure Key Vault Provider for the Secret Store CSI Driver. Here, I present my findings and recommendations based on the functionality, maintenance requirements, and integration capabilities of these tools.
Akv2k8s, maintained by Sparebanken, is an open-source tool designed for the synchronization of secrets. Being dependent on an external tool for Kubernetes secrets synchronization is an undesirable situation and poses several challenges. Notably, the latest version of akv2k8s has been problematic, especially concerning the deployment of Postgres databases on our AKS clusters using the EDB operator. Akv2k8s alters the SecurityContext of pods in a way that causes them to fail."><meta name=author content="Mischa van den Burg"><link rel=canonical href=https://mischavandenburg.com/zet/articles/akv2k8s-azure-key-vault-csi-analysis/><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://mischavandenburg.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://mischavandenburg.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://mischavandenburg.com/favicon-32x32.png><link rel=apple-touch-icon href=https://mischavandenburg.com/apple-touch-icon.png><link rel=mask-icon href=https://mischavandenburg.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://mischavandenburg.com/zet/articles/akv2k8s-azure-key-vault-csi-analysis/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-VLS3GJYW82"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-VLS3GJYW82")}</script><meta property="og:url" content="https://mischavandenburg.com/zet/articles/akv2k8s-azure-key-vault-csi-analysis/"><meta property="og:site_name" content="Mischa van den Burg"><meta property="og:title" content="Comparing akv2k8s with Azure Key Vault Provider for Secret Store CSI Driver"><meta property="og:description" content="In a recent analysis, I explored two notable solutions for synchronizing secrets from Azure Key Vaults to AKS (Azure Kubernetes Service) clusters: akv2k8s and the Azure Key Vault Provider for the Secret Store CSI Driver. Here, I present my findings and recommendations based on the functionality, maintenance requirements, and integration capabilities of these tools.
Akv2k8s, maintained by Sparebanken, is an open-source tool designed for the synchronization of secrets. Being dependent on an external tool for Kubernetes secrets synchronization is an undesirable situation and poses several challenges. Notably, the latest version of akv2k8s has been problematic, especially concerning the deployment of Postgres databases on our AKS clusters using the EDB operator. Akv2k8s alters the SecurityContext of pods in a way that causes them to fail."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="zet"><meta property="article:published_time" content="2024-03-11T00:00:00+00:00"><meta property="article:modified_time" content="2024-03-11T00:00:00+00:00"><meta property="article:tag" content="Article"><meta property="article:tag" content="Azure"><meta property="article:tag" content="Security"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="AKS"><meta property="og:image" content="https://mischavandenburg.com/cloud-blue-logo.jpeg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://mischavandenburg.com/cloud-blue-logo.jpeg"><meta name=twitter:title content="Comparing akv2k8s with Azure Key Vault Provider for Secret Store CSI Driver"><meta name=twitter:description content="In a recent analysis, I explored two notable solutions for synchronizing secrets from Azure Key Vaults to AKS (Azure Kubernetes Service) clusters: akv2k8s and the Azure Key Vault Provider for the Secret Store CSI Driver. Here, I present my findings and recommendations based on the functionality, maintenance requirements, and integration capabilities of these tools.
Akv2k8s, maintained by Sparebanken, is an open-source tool designed for the synchronization of secrets. Being dependent on an external tool for Kubernetes secrets synchronization is an undesirable situation and poses several challenges. Notably, the latest version of akv2k8s has been problematic, especially concerning the deployment of Postgres databases on our AKS clusters using the EDB operator. Akv2k8s alters the SecurityContext of pods in a way that causes them to fail."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Zettelkasten","item":"https://mischavandenburg.com/zet/"},{"@type":"ListItem","position":2,"name":"All Articles","item":"https://mischavandenburg.com/zet/articles/"},{"@type":"ListItem","position":3,"name":"Comparing akv2k8s with Azure Key Vault Provider for Secret Store CSI Driver","item":"https://mischavandenburg.com/zet/articles/akv2k8s-azure-key-vault-csi-analysis/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Comparing akv2k8s with Azure Key Vault Provider for Secret Store CSI Driver","name":"Comparing akv2k8s with Azure Key Vault Provider for Secret Store CSI Driver","description":"In a recent analysis, I explored two notable solutions for synchronizing secrets from Azure Key Vaults to AKS (Azure Kubernetes Service) clusters: akv2k8s and the Azure Key Vault Provider for the Secret Store CSI Driver. Here, I present my findings and recommendations based on the functionality, maintenance requirements, and integration capabilities of these tools.\nAkv2k8s, maintained by Sparebanken, is an open-source tool designed for the synchronization of secrets. Being dependent on an external tool for Kubernetes secrets synchronization is an undesirable situation and poses several challenges. Notably, the latest version of akv2k8s has been problematic, especially concerning the deployment of Postgres databases on our AKS clusters using the EDB operator. Akv2k8s alters the SecurityContext of pods in a way that causes them to fail.\n","keywords":["Article","Azure","Security","Kubernetes","AKS"],"articleBody":"In a recent analysis, I explored two notable solutions for synchronizing secrets from Azure Key Vaults to AKS (Azure Kubernetes Service) clusters: akv2k8s and the Azure Key Vault Provider for the Secret Store CSI Driver. Here, I present my findings and recommendations based on the functionality, maintenance requirements, and integration capabilities of these tools.\nAkv2k8s, maintained by Sparebanken, is an open-source tool designed for the synchronization of secrets. Being dependent on an external tool for Kubernetes secrets synchronization is an undesirable situation and poses several challenges. Notably, the latest version of akv2k8s has been problematic, especially concerning the deployment of Postgres databases on our AKS clusters using the EDB operator. Akv2k8s alters the SecurityContext of pods in a way that causes them to fail.\nFurthermore, upgrading akv2k8s to the latest version necessitates a transition to Workload Identity due to the deprecation of aad-pod-identity, a move that promises to be complex. Conversely, the Azure Key Vault Provider, directly offered by Microsoft, allows continued use of Managed Identities for authentication to Key Vaults, simplifying the integration process.\nhttps://azure.github.io/secrets-store-csi-driver-provider-azure/docs/configurations/identity-access-modes/\nAzure Key Vault Provider for Secret Store CSI Driver The Azure Key Vault Provider for Secret Store CSI Driver is the solution for syncing secrets offered by Microsoft Azure. It is based on the kubernetes-sigs/secrets-store-csi-driver.\nInstallation \u0026 Maintenance The addon is installed with an Azure CLI command or from the portal for existing clusters. The addon can also be enabled from code when deploying a new cluster.\nThe addon is automatically updated when an AKS upgrade to a new minor version is performed. Maintenance of the secret synching solution will not be required anymore and is handled by Azure Kubernetes Service.\nIf an emergency update is necessary, outside of the normal upgrade schedule, it can be updated with the Azure CLI as follows:\naz aks addon update --addon virtual-node --name MyManagedCluster --resource-group MyResourceGroup --subnet-name VirtualNodeSubnet\nAddons can also be patched by upgrading to the latest AKS node image.\nhttps://learn.microsoft.com/en-us/azure/aks/integrations https://learn.microsoft.com/en-gb/azure/aks/node-image-upgrade\nComparison Benefits Of Using The Official Solution The tool is built and maintained by Microsoft and an integral part of the AKS offering Authentication using a managed identity is supported out of the box Supports RBAC based authentication on Key Vaults Automatically updated when performing AKS upgrades One less component for us to maintain Can run alongside akv2k8s We can implement automatic secret rotation We are not dependent on an external project for our secrets management Does not require an initcontainer to inject secrets Cons Will take work to migrate all applications Migration Guide Steps that describe how to migrate from the use of akv2k8s to the CSI drivers.\nenable the addon using the Azure CLI az aks enable-addons --addons azure-keyvault-secrets-provider --name aks-vo-dcp-dev --resource-group rg-vo-dcp-aks-dev-weu-001\nThis does not restart any existing pods or nodes, thus it does not impact the running setup. akv2k8s and the AKV Provider can run simultaneously on the cluster and the workloads can be migrated one by one.\nEnabling the addon creates a Managed Identity. This Managed Identity needs to get the Key Vault Administrator role on the desired Key Vault to be able to retrieve Secrets.\nTo import the secrets, a SecretProviderClass resource is created:\napiVersion: secrets-store.csi.x-k8s.io/v1 kind: SecretProviderClass metadata: name: azure-sync spec: provider: azure parameters: usePodIdentity: \"false\" useVMManagedIdentity: \"true\" # Set to true for using managed identity userAssignedIdentityID: ceb19a0a-941a-4f33-839d-aeace8ffe205 # Set the clientID of the user-assigned managed identity to use KeyvaultName: mischakv01 # Set to the name of your Key Vault cloudName: \"\" # [OPTIONAL for Azure] if not provided, the Azure environment defaults to AzurePublicCloud objects: | array: - | objectName: ExampleSecret objectType: secret # object types: secret, key, or cert objectVersion: \"\" # [OPTIONAL] object versions, default to latest if empty - | objectName: env-secret objectType: secret # object types: secret, key, or cert tenantId: d62ada1b-ca42-4fe2-b9e7-ceb843af0ad # The tenant ID of the key vault secretObjects: # [OPTIONAL] SecretObjects defines the desired state of synced Kubernetes secret objects - data: - key: username # data field to populate objectName: env-secret # name of the mounted content to sync; this could be the object name or the object alias secretName: foosecret # name of the Kubernetes secret object type: Opaque # type of Kubernetes secret object (for example, Opaque, kubernetes.io/tls) The secret is then mounted in to the container during deployment.\nSee this pod example:\nkind: Pod apiVersion: v1 metadata: name: busybox-secrets-store-inline spec: containers: - name: busybox image: registry.k8s.io/e2e-test-images/busybox:1.29-1 command: - \"/bin/sleep\" - \"10000\" volumeMounts: - name: secrets-store01-inline mountPath: \"/mnt/secrets-store\" readOnly: true env: - name: SECRET_USERNAME valueFrom: secretKeyRef: name: foosecret key: username volumes: - name: secrets-store01-inline csi: driver: secrets-store.csi.k8s.io readOnly: true volumeAttributes: secretProviderClass: \"azure-sync\" In this example the secret is accessible as a text file at /mnt/secrets-store inside the container. It is also made available as an environment variable SECRET_USERNAME.\nThe applications on our platform are already using environment variables when using akv2k8s.\nThe application helm charts will need to be updated with the new SecredProviderClass, but the applications themselves don’t need any changes. They will need to be redeployed with the updated configuration though.\nAnother note is that the secret must always be mounted even it is only used as an environment variable.\nConclusions Migrating to the Azure Key Vault Provider for Secret Store CSI Driver presents no disadvantages. There will be one less component to maintain, and it will always be compatible with the AKS offering.\nIt will require some work to convert the current workloads to use the CSI driver, but this is a one-time action which will not affect the applications while they are running. On the long term, this will pay itself back, because there is one less component to maintain.\nLinks: 202403111503\n","wordCount":"940","inLanguage":"en","image":"https://mischavandenburg.com/cloud-blue-logo.jpeg","datePublished":"2024-03-11T00:00:00Z","dateModified":"2024-03-11T00:00:00Z","author":{"@type":"Person","name":"Mischa van den Burg"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://mischavandenburg.com/zet/articles/akv2k8s-azure-key-vault-csi-analysis/"},"publisher":{"@type":"Organization","name":"Mischa van den Burg","logo":{"@type":"ImageObject","url":"https://mischavandenburg.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://mischavandenburg.com/ accesskey=h title="Mischa van den Burg (Alt + H)">Mischa van den Burg</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://mischavandenburg.com/aboutme/ title=About><span>About</span></a></li><li><a href=https://mischavandenburg.com/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://mischavandenburg.com/archives/ title=Index><span>Index</span></a></li><li><a href=https://mischavandenburg.com/search/ title="🔍 (Alt + /)" accesskey=/><span>🔍</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Comparing akv2k8s with Azure Key Vault Provider for Secret Store CSI Driver</h1><div class=post-meta><span title='2024-03-11 00:00:00 +0000 UTC'>March 11, 2024</span>&nbsp;·&nbsp;Mischa van den Burg</div></header><div class=post-content><p>In a recent analysis, I explored two notable solutions for synchronizing secrets from Azure Key Vaults to AKS (Azure Kubernetes Service) clusters: akv2k8s and the Azure Key Vault Provider for the Secret Store CSI Driver. Here, I present my findings and recommendations based on the functionality, maintenance requirements, and integration capabilities of these tools.</p><p>Akv2k8s, maintained by Sparebanken, is an open-source tool designed for the synchronization of secrets. Being dependent on an external tool for Kubernetes secrets synchronization is an undesirable situation and poses several challenges. Notably, the latest version of akv2k8s has been problematic, especially concerning the deployment of Postgres databases on our AKS clusters using the EDB operator. Akv2k8s alters the SecurityContext of pods in a way that causes them to fail.</p><p>Furthermore, upgrading akv2k8s to the latest version necessitates a transition to Workload Identity due to the deprecation of aad-pod-identity, a move that promises to be complex. Conversely, the Azure Key Vault Provider, directly offered by Microsoft, allows continued use of Managed Identities for authentication to Key Vaults, simplifying the integration process.</p><p><a href=https://azure.github.io/secrets-store-csi-driver-provider-azure/docs/configurations/identity-access-modes/>https://azure.github.io/secrets-store-csi-driver-provider-azure/docs/configurations/identity-access-modes/</a></p><h1 id=azure-key-vault-provider-for-secret-store-csi-driver>Azure Key Vault Provider for Secret Store CSI Driver<a hidden class=anchor aria-hidden=true href=#azure-key-vault-provider-for-secret-store-csi-driver>#</a></h1><p>The Azure Key Vault Provider for Secret Store CSI Driver is the solution for syncing secrets offered by Microsoft Azure. It is based on the <a href=https://github.com/kubernetes-sigs/secrets-store-csi-driver>kubernetes-sigs/secrets-store-csi-driver</a>.</p><h1 id=installation--maintenance>Installation & Maintenance<a hidden class=anchor aria-hidden=true href=#installation--maintenance>#</a></h1><p>The addon is installed with an Azure CLI command or from the portal for existing clusters. The addon can also be enabled from code when deploying a new cluster.</p><p>The addon is automatically updated when an AKS upgrade to a new minor version is performed. <strong>Maintenance of the secret synching solution will not be required anymore and is handled by Azure Kubernetes Service.</strong></p><p>If an emergency update is necessary, outside of the normal upgrade schedule, it can be updated with the Azure CLI as follows:</p><p><code>az aks addon update --addon virtual-node --name MyManagedCluster --resource-group MyResourceGroup --subnet-name VirtualNodeSubnet</code></p><p>Addons can also be patched by upgrading to the latest AKS node image.</p><p><a href=https://learn.microsoft.com/en-us/azure/aks/integrations>https://learn.microsoft.com/en-us/azure/aks/integrations</a>
<a href=https://learn.microsoft.com/en-gb/azure/aks/node-image-upgrade>https://learn.microsoft.com/en-gb/azure/aks/node-image-upgrade</a></p><h1 id=comparison>Comparison<a hidden class=anchor aria-hidden=true href=#comparison>#</a></h1><h2 id=benefits-of-using-the-official-solution>Benefits Of Using The Official Solution<a hidden class=anchor aria-hidden=true href=#benefits-of-using-the-official-solution>#</a></h2><ul><li>The tool is built and maintained by Microsoft and an integral part of the AKS offering</li><li>Authentication using a managed identity is supported out of the box</li><li>Supports RBAC based authentication on Key Vaults</li><li>Automatically updated when performing AKS upgrades</li><li>One less component for us to maintain</li><li>Can run alongside akv2k8s</li><li>We can implement automatic secret rotation</li><li>We are not dependent on an external project for our secrets management</li><li>Does not require an initcontainer to inject secrets</li></ul><h2 id=cons>Cons<a hidden class=anchor aria-hidden=true href=#cons>#</a></h2><ul><li>Will take work to migrate all applications</li></ul><h1 id=migration-guide>Migration Guide<a hidden class=anchor aria-hidden=true href=#migration-guide>#</a></h1><p>Steps that describe how to migrate from the use of akv2k8s to the CSI drivers.</p><ul><li>enable the addon using the Azure CLI</li></ul><p><code>az aks enable-addons --addons azure-keyvault-secrets-provider --name aks-vo-dcp-dev --resource-group rg-vo-dcp-aks-dev-weu-001</code></p><p>This does not restart any existing pods or nodes, thus it does not impact the running setup. akv2k8s and the AKV Provider can run simultaneously on the cluster and the workloads can be migrated one by one.</p><p>Enabling the addon creates a Managed Identity. This Managed Identity needs to get the Key Vault Administrator role on the desired Key Vault to be able to retrieve Secrets.</p><p>To import the secrets, a SecretProviderClass resource is created:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>secrets-store.csi.x-k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>SecretProviderClass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>azure-sync</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>provider</span><span class=p>:</span><span class=w> </span><span class=l>azure</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>parameters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>usePodIdentity</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;false&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>useVMManagedIdentity</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w> </span><span class=c># Set to true for using managed identity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>userAssignedIdentityID</span><span class=p>:</span><span class=w> </span><span class=l>ceb19a0a-941a-4f33-839d-aeace8ffe205</span><span class=w> </span><span class=c># Set the clientID of the user-assigned managed identity to use</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>KeyvaultName</span><span class=p>:</span><span class=w> </span><span class=l>mischakv01</span><span class=w> </span><span class=c># Set to the name of your Key Vault</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cloudName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w> </span><span class=c># [OPTIONAL for Azure] if not provided, the Azure environment defaults to AzurePublicCloud</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>objects</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      array:
</span></span></span><span class=line><span class=cl><span class=sd>        - |
</span></span></span><span class=line><span class=cl><span class=sd>          objectName: ExampleSecret
</span></span></span><span class=line><span class=cl><span class=sd>          objectType: secret              # object types: secret, key, or cert
</span></span></span><span class=line><span class=cl><span class=sd>          objectVersion: &#34;&#34;               # [OPTIONAL] object versions, default to latest if empty
</span></span></span><span class=line><span class=cl><span class=sd>        - |
</span></span></span><span class=line><span class=cl><span class=sd>          objectName: env-secret
</span></span></span><span class=line><span class=cl><span class=sd>          objectType: secret              # object types: secret, key, or cert</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tenantId</span><span class=p>:</span><span class=w> </span><span class=l>d62ada1b-ca42-4fe2-b9e7-ceb843af0ad</span><span class=w> </span><span class=c># The tenant ID of the key vault</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>secretObjects</span><span class=p>:</span><span class=w> </span><span class=c># [OPTIONAL] SecretObjects defines the desired state of synced Kubernetes secret objects</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>username</span><span class=w> </span><span class=c># data field to populate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>objectName</span><span class=p>:</span><span class=w> </span><span class=l>env-secret</span><span class=w> </span><span class=c># name of the mounted content to sync; this could be the object name or the object alias</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>foosecret</span><span class=w> </span><span class=c># name of the Kubernetes secret object</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Opaque</span><span class=w> </span><span class=c># type of Kubernetes secret object (for example, Opaque, kubernetes.io/tls)</span><span class=w>
</span></span></span></code></pre></div><p>The secret is then mounted in to the container during deployment.</p><p>See this pod example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>busybox-secrets-store-inline</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>registry.k8s.io/e2e-test-images/busybox:1.29-1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;/bin/sleep&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;10000&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secrets-store01-inline</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/mnt/secrets-store&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>SECRET_USERNAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>foosecret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>username</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secrets-store01-inline</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>csi</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>driver</span><span class=p>:</span><span class=w> </span><span class=l>secrets-store.csi.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeAttributes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>secretProviderClass</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;azure-sync&#34;</span><span class=w>
</span></span></span></code></pre></div><p>In this example the secret is accessible as a text file at /mnt/secrets-store inside the container. It is also made available as an environment variable SECRET_USERNAME.</p><p>The applications on our platform are already using environment variables when using akv2k8s.</p><p>The application helm charts will need to be updated with the new SecredProviderClass, but the applications themselves don&rsquo;t need any changes. They will need to be redeployed with the updated configuration though.</p><p>Another note is that the secret must always be mounted even it is only used as an environment variable.</p><h1 id=conclusions>Conclusions<a hidden class=anchor aria-hidden=true href=#conclusions>#</a></h1><p>Migrating to the Azure Key Vault Provider for Secret Store CSI Driver presents no disadvantages. There will be one less component to maintain, and it will always be compatible with the AKS offering.</p><p>It will require some work to convert the current workloads to use the CSI driver, but this is a one-time action which will not affect the applications while they are running. On the long term, this will pay itself back, because there is one less component to maintain.</p><h2 id=links>Links:<a hidden class=anchor aria-hidden=true href=#links>#</a></h2><p>202403111503</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://mischavandenburg.com/tags/article/>Article</a></li><li><a href=https://mischavandenburg.com/tags/azure/>Azure</a></li><li><a href=https://mischavandenburg.com/tags/security/>Security</a></li><li><a href=https://mischavandenburg.com/tags/kubernetes/>Kubernetes</a></li><li><a href=https://mischavandenburg.com/tags/aks/>AKS</a></li></ul><nav class=paginav><a class=prev href=https://mischavandenburg.com/zet/remove-background-image-macos/><span class=title>« Prev</span><br><span>Remove Backgrounds from Images using MacOS Preview</span>
</a><a class=next href=https://mischavandenburg.com/zet/articles/gateway-api-application-gateway-for-containers/><span class=title>Next »</span><br><span>Kubernetes Gateway API & Azure Application Gateway for Containers</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Comparing akv2k8s with Azure Key Vault Provider for Secret Store CSI Driver on x" href="https://x.com/intent/tweet/?text=Comparing%20akv2k8s%20with%20Azure%20Key%20Vault%20Provider%20for%20Secret%20Store%20CSI%20Driver&amp;url=https%3a%2f%2fmischavandenburg.com%2fzet%2farticles%2fakv2k8s-azure-key-vault-csi-analysis%2f&amp;hashtags=Article%2cAzure%2cSecurity%2cKubernetes%2cAKS"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Comparing akv2k8s with Azure Key Vault Provider for Secret Store CSI Driver on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fmischavandenburg.com%2fzet%2farticles%2fakv2k8s-azure-key-vault-csi-analysis%2f&amp;title=Comparing%20akv2k8s%20with%20Azure%20Key%20Vault%20Provider%20for%20Secret%20Store%20CSI%20Driver&amp;summary=Comparing%20akv2k8s%20with%20Azure%20Key%20Vault%20Provider%20for%20Secret%20Store%20CSI%20Driver&amp;source=https%3a%2f%2fmischavandenburg.com%2fzet%2farticles%2fakv2k8s-azure-key-vault-csi-analysis%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Comparing akv2k8s with Azure Key Vault Provider for Secret Store CSI Driver on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fmischavandenburg.com%2fzet%2farticles%2fakv2k8s-azure-key-vault-csi-analysis%2f&title=Comparing%20akv2k8s%20with%20Azure%20Key%20Vault%20Provider%20for%20Secret%20Store%20CSI%20Driver"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Comparing akv2k8s with Azure Key Vault Provider for Secret Store CSI Driver on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fmischavandenburg.com%2fzet%2farticles%2fakv2k8s-azure-key-vault-csi-analysis%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Comparing akv2k8s with Azure Key Vault Provider for Secret Store CSI Driver on whatsapp" href="https://api.whatsapp.com/send?text=Comparing%20akv2k8s%20with%20Azure%20Key%20Vault%20Provider%20for%20Secret%20Store%20CSI%20Driver%20-%20https%3a%2f%2fmischavandenburg.com%2fzet%2farticles%2fakv2k8s-azure-key-vault-csi-analysis%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Comparing akv2k8s with Azure Key Vault Provider for Secret Store CSI Driver on telegram" href="https://telegram.me/share/url?text=Comparing%20akv2k8s%20with%20Azure%20Key%20Vault%20Provider%20for%20Secret%20Store%20CSI%20Driver&amp;url=https%3a%2f%2fmischavandenburg.com%2fzet%2farticles%2fakv2k8s-azure-key-vault-csi-analysis%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Comparing akv2k8s with Azure Key Vault Provider for Secret Store CSI Driver on ycombinator" href="https://news.ycombinator.com/submitlink?t=Comparing%20akv2k8s%20with%20Azure%20Key%20Vault%20Provider%20for%20Secret%20Store%20CSI%20Driver&u=https%3a%2f%2fmischavandenburg.com%2fzet%2farticles%2fakv2k8s-azure-key-vault-csi-analysis%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://mischavandenburg.com/>Mischa van den Burg</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>