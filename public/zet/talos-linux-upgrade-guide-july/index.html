<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Talos Linux Upgrade Guide July | Mischa van den Burg</title>
<meta name=keywords content="Kubernetes,Homelab,Talos"><meta name=description content='I upgraded my homelab cluster using Talos Linux today.
I made a mistake and forgot to use the custom-built image using iscsi-tools.
Learning the hard way.
Here are my notes:
Talos upgrade [!IMPORTANT] Remember to create a custom image including iscsi-tools
Set up CLI environment and set databases to maintenance mode export TALOS_CP="192.168.100.107" export TALOS_W1="192.168.100.245" export TALOS_W2="192.168.100.60" k cnp maintenance set --all-namespaces [!WARNING] Use the --preserve flag on single-node control plane clusters.'><meta name=author content="Mischa van den Burg"><link rel=canonical href=https://mischavandenburg.com/zet/talos-linux-upgrade-guide-july/><link crossorigin=anonymous href=/assets/css/stylesheet.min.e8ea20f7f0e32f55c23c7678de2e8bbd8c3aded5d82a4627a2038bf47ea08344.css integrity="sha256-6Oog9/DjL1XCPHZ43i6LvYw63tXYKkYnogOL9H6gg0Q=" rel="preload stylesheet" as=style><link rel=icon href=https://mischavandenburg.com/favicon.ico><link rel=apple-touch-icon href=https://mischavandenburg.com/apple-touch-icon.png><link rel=alternate hreflang=en href=https://mischavandenburg.com/zet/talos-linux-upgrade-guide-july/><script async src="https://www.googletagmanager.com/gtag/js?id=G-VLS3GJYW82"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-VLS3GJYW82")}</script><meta name=twitter:card content="summary"><meta name=twitter:title content="Talos Linux Upgrade Guide July | Mischa van den Burg"><meta name=twitter:description content='I upgraded my homelab cluster using Talos Linux today.
I made a mistake and forgot to use the custom-built image using iscsi-tools.
Learning the hard way.
Here are my notes:
Talos upgrade [!IMPORTANT] Remember to create a custom image including iscsi-tools
Set up CLI environment and set databases to maintenance mode export TALOS_CP="192.168.100.107" export TALOS_W1="192.168.100.245" export TALOS_W2="192.168.100.60" k cnp maintenance set --all-namespaces [!WARNING] Use the --preserve flag on single-node control plane clusters.'><meta property="og:title" content="Talos Linux Upgrade Guide July | Mischa van den Burg"><meta property="og:description" content='I upgraded my homelab cluster using Talos Linux today.
I made a mistake and forgot to use the custom-built image using iscsi-tools.
Learning the hard way.
Here are my notes:
Talos upgrade [!IMPORTANT] Remember to create a custom image including iscsi-tools
Set up CLI environment and set databases to maintenance mode export TALOS_CP="192.168.100.107" export TALOS_W1="192.168.100.245" export TALOS_W2="192.168.100.60" k cnp maintenance set --all-namespaces [!WARNING] Use the --preserve flag on single-node control plane clusters.'><meta property="og:type" content="article"><meta property="og:url" content="https://mischavandenburg.com/zet/talos-linux-upgrade-guide-july/"><meta property="og:image" content="https://mischavandenburg.com/cloud-blue-logo.jpeg"><meta property="article:section" content="zet"><meta property="article:published_time" content="2024-07-31T00:00:00+00:00"><meta property="article:modified_time" content="2024-07-31T00:00:00+00:00"><meta property="og:site_name" content="Mischa van den Burg - Blog"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Zettelkasten","item":"https://mischavandenburg.com/zet/"},{"@type":"ListItem","position":2,"name":"Talos Linux Upgrade Guide July","item":"https://mischavandenburg.com/zet/talos-linux-upgrade-guide-july/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Talos Linux Upgrade Guide July | Mischa van den Burg","name":"Talos Linux Upgrade Guide July","description":"I upgraded my homelab cluster using Talos Linux today.\nI made a mistake and forgot to use the custom-built image using iscsi-tools.\nLearning the hard way.\nHere are my notes:\nTalos upgrade [!IMPORTANT] Remember to create a custom image including iscsi-tools\nSet up CLI environment and set databases to maintenance mode export TALOS_CP=\u0026#34;192.168.100.107\u0026#34; export TALOS_W1=\u0026#34;192.168.100.245\u0026#34; export TALOS_W2=\u0026#34;192.168.100.60\u0026#34; k cnp maintenance set --all-namespaces [!WARNING] Use the --preserve flag on single-node control plane clusters.","keywords":["Kubernetes","Homelab","Talos"],"wordCount":"342","inLanguage":"en","datePublished":"2024-07-31T00:00:00Z","dateModified":"2024-07-31T00:00:00Z","author":{"@type":"Person","name":"Mischa van den Burg"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://mischavandenburg.com/zet/talos-linux-upgrade-guide-july/"},"publisher":{"@type":"Organization","name":"Mischa van den Burg","logo":{"@type":"ImageObject","url":"https://mischavandenburg.com/favicon.ico"}}}</script><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary-bg:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list-page{background:var(--theme)}.list-page:not(.dark)::-webkit-scrollbar-track{background:0 0}.list-page:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript></head><body class="type-zet kind-page layout-" id=top><script data-no-instant>function switchTheme(e){switch(e){case"light":document.body.classList.remove("dark");break;case"dark":document.body.classList.add("dark");break;default:window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")}}function isDarkTheme(){return document.body.className.includes("dark")}function getPrefTheme(){return localStorage.getItem("pref-theme")}function setPrefTheme(e){switchTheme(e),localStorage.setItem("pref-theme",e)}const toggleThemeCallbacks={};toggleThemeCallbacks.main=e=>{setPrefTheme(e?"light":"dark")},window.addEventListener("toggle-theme",function(){const e=isDarkTheme();for(const t in toggleThemeCallbacks)toggleThemeCallbacks[t](e)});function toggleThemeListener(){window.dispatchEvent(new CustomEvent("toggle-theme"))}</script><script>(function(){const t="auto",e=getPrefTheme(),n=e||t;switchTheme(n)})()</script><header class=header><nav class=nav><div class=logo><a href=https://mischavandenburg.com/ accesskey=h title="Mischa van den Burg (Alt + H)">Mischa van den Burg</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://mischavandenburg.com/aboutme/ title=About>About</a></li><li><a href=https://mischavandenburg.com/services/ title=Services>Services</a></li><li><a href=https://mischavandenburg.com/coaching/ title=Coaching>Coaching</a></li><li><a href=https://mischavandenburg.com/courses/ title=Courses>Courses</a></li><li><a href=https://mischavandenburg.com/contact/ title=Contact>Contact</a></li><li><a href=https://mischavandenburg.com/tags/ title=Tags>Tags</a></li><li><a href=https://mischavandenburg.com/archives/ title=Index>Index</a></li><li><a href=https://mischavandenburg.com/search/ title="üîç (Alt + /)" data-no-instant accesskey=/>üîç</a></li></ul></nav><a rel=me href=https://toot.community/@mischavandenburg></a></header><main class="main post"><article class=post-single><header class=post-header><h1 class=post-title>Talos Linux Upgrade Guide July</h1><div class=post-meta><span class=meta-item><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg>
<span>July 31, 2024</span></span><span class=meta-item>
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon" style="user-select:text"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z" style="user-select:text"/><line x1="7" y1="7" x2="7" y2="7" style="user-select:text"/></svg>
<span class=post-tags><a href=https://mischavandenburg.com/tags/kubernetes/>Kubernetes</a><a href=https://mischavandenburg.com/tags/homelab/>Homelab</a><a href=https://mischavandenburg.com/tags/talos/>Talos</a></span></span></div></header><div class=post-content><p>I upgraded my homelab cluster using Talos Linux today.</p><p>I made a mistake and forgot to use the custom-built image using iscsi-tools.</p><p>Learning the hard way.</p><p>Here are my notes:</p><h2 id=talos-upgrade>Talos upgrade<a hidden class=anchor aria-hidden=true href=#talos-upgrade>¬∂</a></h2><blockquote><p>[!IMPORTANT]
Remember to create a custom image including iscsi-tools</p></blockquote><h3 id=set-up-cli-environment-and-set-databases-to-maintenance-mode>Set up CLI environment and set databases to maintenance mode<a hidden class=anchor aria-hidden=true href=#set-up-cli-environment-and-set-databases-to-maintenance-mode>¬∂</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>TALOS_CP</span><span class=o>=</span><span class=s2>&#34;192.168.100.107&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>TALOS_W1</span><span class=o>=</span><span class=s2>&#34;192.168.100.245&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>TALOS_W2</span><span class=o>=</span><span class=s2>&#34;192.168.100.60&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>k cnp maintenance <span class=nb>set</span> --all-namespaces
</span></span></code></pre></div><blockquote><p>[!WARNING]
Use the <code>--preserve</code> flag on single-node control plane clusters.
Only needed for the control plane node.</p></blockquote><h3 id=upgrade-path>Upgrade path:<a hidden class=anchor aria-hidden=true href=#upgrade-path>¬∂</a></h3><ol><li>from 1.6.4 to 1.6.8</li><li>from 1.6.8 to 1.7.5</li></ol><h3 id=upgrade-1>Upgrade 1<a hidden class=anchor aria-hidden=true href=#upgrade-1>¬∂</a></h3><blockquote><p>[!NOTE]
I made a mistake and did not update to the custom-built image including the iscsi-tools
This caused my cluster storage to break.</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>talosctl upgrade --preserve --nodes <span class=nv>$TALOS_CP</span> -e <span class=nv>$TALOS_CP</span> --image ghcr.io/siderolabs/installer:v1.6.8
</span></span><span class=line><span class=cl>talosctl upgrade --nodes <span class=nv>$TALOS_W1</span> -e <span class=nv>$TALOS_CP</span> --image ghcr.io/siderolabs/installer:v1.6.8
</span></span><span class=line><span class=cl>talosctl upgrade --nodes <span class=nv>$TALOS_W2</span> -e <span class=nv>$TALOS_CP</span> --image ghcr.io/siderolabs/installer:v1.6.8
</span></span></code></pre></div><h3 id=upgrade-2>Upgrade 2<a hidden class=anchor aria-hidden=true href=#upgrade-2>¬∂</a></h3><p>I went to <a href=https://factory.talos.dev/>https://factory.talos.dev/</a> and created a new image including iscsi-tools.</p><p>Everything worked fine after that.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>talosctl upgrade --preserve --nodes <span class=nv>$TALOS_CP</span> -e <span class=nv>$TALOS_CP</span> --image factory.talos.dev/installer/c9078f9419961640c712a8bf2bb9174933dfcf1da383fd8ea2b7dc21493f8bac:v1.7.5
</span></span><span class=line><span class=cl>talosctl upgrade --nodes <span class=nv>$TALOS_W1</span> -e <span class=nv>$TALOS_CP</span> --image factory.talos.dev/installer/c9078f9419961640c712a8bf2bb9174933dfcf1da383fd8ea2b7dc21493f8bac:v1.7.5
</span></span><span class=line><span class=cl>talosctl upgrade --nodes <span class=nv>$TALOS_W2</span> -e <span class=nv>$TALOS_CP</span> --image factory.talos.dev/installer/c9078f9419961640c712a8bf2bb9174933dfcf1da383fd8ea2b7dc21493f8bac:v1.7.5
</span></span></code></pre></div><h2 id=kubernetes-upgrade>Kubernetes Upgrade<a hidden class=anchor aria-hidden=true href=#kubernetes-upgrade>¬∂</a></h2><blockquote><p>[!WARNING]
Make sure to upgrade the Talos CLI before proceeding.
&ldquo;It is advisable to use the same version of talosctl as the version of the boot media used.&rdquo; - Talos Docs</p></blockquote><h3 id=upgrade-path-1>Upgrade Path<a hidden class=anchor aria-hidden=true href=#upgrade-path-1>¬∂</a></h3><ol><li>From 1.29.0 to 1.29.3</li><li>From 1.29.3 to 1.30.3</li></ol><blockquote><p>[!NOTE]</p></blockquote><blockquote><p>[!NOTE]
To trigger a Kubernetes upgrade, issue a command specifying the version of Kubernetes to upgrade to, such as:
talosctl &ndash;nodes upgrade-k8s &ndash;to 1.30.0
Note that the &ndash;nodes parameter specifies the control plane node to send the API call to, but all members of the cluster will be upgraded.
To check what will be upgraded you can run talosctl upgrade-k8s with the &ndash;dry-run flag</p></blockquote><h3 id=round-1>Round 1<a hidden class=anchor aria-hidden=true href=#round-1>¬∂</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>k cnp maintenance <span class=nb>set</span> --all-namespaces
</span></span><span class=line><span class=cl>kubent
</span></span><span class=line><span class=cl>talosctl --nodes <span class=nv>$TALOS_CP</span> -e <span class=nv>$TALOS_CP</span> upgrade-k8s --to 1.29.3 --dry-run
</span></span><span class=line><span class=cl>talosctl --nodes <span class=nv>$TALOS_CP</span> -e <span class=nv>$TALOS_CP</span> upgrade-k8s --to 1.29.3
</span></span></code></pre></div><h3 id=round-2>Round 2<a hidden class=anchor aria-hidden=true href=#round-2>¬∂</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>k cnp maintenance <span class=nb>set</span> --all-namespaces
</span></span><span class=line><span class=cl>kubent
</span></span><span class=line><span class=cl>talosctl --nodes <span class=nv>$TALOS_CP</span> -e <span class=nv>$TALOS_CP</span> upgrade-k8s --to 1.30.3 --dry-run
</span></span><span class=line><span class=cl>talosctl --nodes <span class=nv>$TALOS_CP</span> -e <span class=nv>$TALOS_CP</span> upgrade-k8s --to 1.30.3
</span></span></code></pre></div><h2 id=links>Links:<a hidden class=anchor aria-hidden=true href=#links>¬∂</a></h2><p>202407311407</p></div><footer class=post-footer><nav class=paginav><a class=prev href=https://mischavandenburg.com/zet/i-set-up-pi-hole-on-my-synology-nas/><span class=title><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></svg>&nbsp;Prev Page</span><br><span>I set up Pi-hole on my Synology NAS</span>
</a><a class=next href=https://mischavandenburg.com/zet/my-updated-backup-setup-for-my-obsidian-zetelkasten/><span class=title>Next Page&nbsp;<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span><br><span>No More GitHub - My Updated Backup Setup For My Obsidian Zettelkasten</span></a></nav></footer><div class=comments-separator></div></article></main><footer class=footer><span>&copy; 2024 <a href=https://mischavandenburg.com/>Mischa van den Burg</a></span><span style=display:inline-block;margin-left:1em>
<a href=https://creativecommons.org/licenses/by-nc-nd/4.0/>CC BY-NC-ND</a>
</span><span style=display:inline-block;margin-left:1em><a href=https://mischavandenburg.com/skool>My Community -</a>
<a href=https://twitter.com/mischa_vdburg>Twitter</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>(function(){const t=""=="1";if(t)return;let e=document.getElementById("theme-toggle");e.removeEventListener("click",toggleThemeListener),e.addEventListener("click",toggleThemeListener)})()</script><script>(function(){let e=document.getElementById("menu");e&&(e.scrollLeft=localStorage.getItem("menu-scroll-position"),e.onscroll=function(){localStorage.setItem("menu-scroll-position",e.scrollLeft)});const t=""=="1",n=""=="1";if(window.matchMedia("(prefers-reduced-motion: reduce)").matches||t||n)return;document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})})()</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>if(window.scrollListeners)for(const e of scrollListeners)window.removeEventListener("scroll",e);window.scrollListeners=[]</script><script src=/js/medium-zoom.min.js data-no-instant></script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script>(function(){const a=""=="1";if(!a)return;if(!document.querySelector(".toc")){console.log("no toc found, ignore toc scroll");return}const r=window.scrollListeners,t=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id]"),n="active";let e=t[0];o(e).classList.add(n);const c=()=>{const s=[];for(const e of t)if(l(e)<5)s.push(e);else break;s.length>0?newActiveHeading=s[s.length-1]:newActiveHeading=t[0],e!=newActiveHeading&&(o(e).classList.remove(n),e=newActiveHeading,o(e).classList.add(n))};let s=null;const i=()=>{s!==null&&clearTimeout(s),s=setTimeout(c,50)};window.addEventListener("scroll",i,!1),r.push(i);function o(e){const t=encodeURI(e.getAttribute("id")).toLowerCase();return document.querySelector(`.toc ul li a[href="#${t}"]`)}function l(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect();return t.top}})()</script></body></html>